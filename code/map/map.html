<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="UTF-8"/>
        <title>Canada</title>
        <link rel="stylesheet" href="css/html.css"/>
        <link rel="stylesheet" href="css/ol.css" type="text/css"/>
        <link rel="stylesheet" href="css/map.css"/>
            <script src="js/ol.js" type="text/javascript"></script>
            <script src="js/mapbox-streets-v6-style.js" type="text/javascript"></script>
            <script src="js/key.js" type="text/javascript"></script>
            <script src="js/utilities.js" type="text/javascript"></script>
            <script src="js/postalcodes.js" type="text/javascript"></script>
            <style>
      .map {
        background: #f8f4f0;
      }
    </style>
    </head>
    <body>
        <div id="map" class="map"></div>
        <script type="text/javascript">
            //<![CDATA[

            <!--
            
            //Create default style for riding points.
            var strokeRiding = new ol.style.Stroke({color: 'black', width: 2});
            var fillRiding = new ol.style.Fill({color: 'rgba(255, 204, 51, 0.5)'});
            var strokePostalCode = new ol.style.Stroke({color: '#ff0000', width: 2});
            var fillPostalCode = new ol.style.Fill({color: 'rgba(255, 0, 0, 0.2)'});
            
            
            var ridingStyle = new ol.style.Style({
              image: new ol.style.Circle({
                fill: fillRiding,
                stroke: strokeRiding,
                radius: 7
              })
            });
            
            var getPostalCodeStyle = function (feat, resolution){
              return new ol.style.Style({
                image: new ol.style.RegularShape({
                  fill: fillPostalCode,
                  stroke: strokePostalCode,
                  points: 5,
                  radius: 10,
                  radius2: 4,
                  angle: 0
                }),
                text: new ol.style.Text({
                  text: feat.get('id'),
                  align: center,
                  offsetY: -20,
                  stroke: new ol.style.Stroke({color: 'white', width: 4}),
                  font: 'bold 16px Georgia'
                })
              });
            };
            
            function parseSearch(){
              var i, maxi, feat;
              var targPlace = getQueryParam('place');
              var targPostalCode = getQueryParam('postalCode');
              if (targPlace.length > 0){
                 feat = srcRidings.getFeatureById(targPlace);
                 if (feat !== null){
                    setupMapPopup();
                    document.getElementById('mapPopup').innerHTML = featureToHtml(feat);
                    mapPopup.setPosition(feat.getGeometry().getCoordinates());
                    zoomToFeature(feat);
                 }
              }
              if (targPostalCode.length > 0){
                 jumpToPostalCode(targPostalCode);
              }
            };
                        
            //Create a vector layer for the ridings.
            var srcRidings = new ol.source.Vector({
              url: 'js/places.json',
              format:  new ol.format.GeoJSON()
            });
            
            var ridingsLoadedFunc = function(){
              if (srcRidings.getState() == 'ready'){
                srcRidings.un('change', ridingsLoadedFunc);
                parseSearch();
              }
            }
            
            srcRidings.on('change', ridingsLoadedFunc);
            
            var layerRidings = new ol.layer.Vector({
              source: srcRidings,
              style: ridingStyle
            });
            
            //Create another unsourced layer for the user-entered postal codes.
            var srcPostalCodes = new ol.source.Vector({
              format:  new ol.format.GeoJSON()
            });
            var layerPostalCodes = new ol.layer.Vector({
              source: srcPostalCodes,
              style: getPostalCodeStyle
            });
            
            var key = APIKey;
            
            //Longitudinal centre of Canada per https://en.wikipedia.org/wiki/Centre_of_Canada;
            //latitudinal adjusted by me.
            var center = [-96.8097,56.6277];
            var bounds = [-141.9903, 76.1156, -49.1778, 44.2580];
      
            var map = new ol.Map({
              layers: [
                new ol.layer.VectorTile({
                  source: new ol.source.VectorTile({
                    crossOrigin: 'anonymous',
                    attributions: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> ' +
                      '© <a href="https://www.openstreetmap.org/copyright">' +
                      'OpenStreetMap contributors</a>',
                    format: new ol.format.MVT(),
                    tileGrid: ol.tilegrid.createXYZ({maxZoom: 17}),
                    tilePixelRatio: 16,
                    url: 'https://{a-d}.tiles.mapbox.com/v4/mapbox.mapbox-streets-v6/' +
                        '{z}/{x}/{y}.vector.pbf?access_token=' + key
                  }),
                  style: createMapboxStreetsV6Style()
                }),
                layerRidings,
                layerPostalCodes
              ],
              target: 'map',
              view: new ol.View({
                bounds: bounds,
                center: ol.proj.fromLonLat(center),
                //projection: 'EPSG:3857',
                zoom: 4,
                maxZoom: 16,
                minZoom: 4
              })
            });
            
            var mapPopup = null;
            
            //Add a crude click event so you can see the info on a riding.
            //Later this will show whatever it is we want to show.
            map.on("click", function(e) {
              map.forEachFeatureAtPixel(e.pixel, function (feature, layer) {
                  setupMapPopup();
                  if (feature.getProperties().notBefore){
                    //document.getElementById('mapPopup').innerHTML = featureToHtml(feature);
                    placePopup(feature);
                    mapPopup.setPosition(e.coordinate);
                  }
              })
            });
            
            function featureToHtml(feature){
              var props = feature.getProperties();
              var ret = '<div class="popupCloser" onclick="mapPopup.setPosition([-2000,-2000])">✕</div>';
              ret += '<span class="placeName" title="' + feature.getId() + '">' + props.name + '</span><br/>';
              ret += '(' + props.notBefore;
              if (props.notAfter !== ''){ret += '-' + props.notAfter;}
              ret += ')<br/>';
              if (props.federal == true){ret += 'Fed.';}
              else{ret += 'Non-fed.';}
              return ret;
            }
            
            function reqLoad(){
              var ret = '<div class="popupCloser" onclick="mapPopup.setPosition([-2000,-2000])">✕</div>';
              ret += this.responseText;
              document.getElementById('mapPopup').innerHTML = ret;
            }
            
            function placePopup(feature){
              var id = feature.getId();
              var oReq = new XMLHttpRequest();
              oReq.addEventListener('load', reqLoad);
              oReq.open('GET', 'ajax/' + id + '.xml');
              oReq.send();
            }
            
            function setupMapPopup(){
              if (mapPopup == null){
                     mapPopup = new ol.Overlay({
                        element: document.getElementById('mapPopup'),
                        positioning: 'bottom-center',
                        offset: [0, -5]
                      });
                     map.addOverlay(mapPopup);
                  }
            }
            
            function zoomToFeature(feat){
              map.getView().animate({
                //center: ol.proj.fromLonLat(feat.getGeometry().getCoordinates()),
                center: feat.getGeometry().getCoordinates(),
                zoom: 8,
                duration: 2000
              });
            }

      // ol.style.Fill, ol.style.Icon, ol.style.Stroke, ol.style.Style and
      // ol.style.Text are required for createMapboxStreetsV6Style()
      
        //-->
        
        //]]>
    </script>
      
      <div id="postalCodeForm">
        <label for="txtPostalCode">Enter your postal code</label>
        <input type="text" maxlength="7" id="txtPostalCode" value="v8z2s3" onkeyup="if (event.keyCode == 13){jumpToPostalCode(this.value)}; return false;"/>
        <button id="btnPostalCode" onclick="jumpToPostalCode(document.getElementById('txtPostalCode').value); return false;">Go</button>
      </div>
      
      <div id="mapPopup">
        
      </div>
    </body>
</html>